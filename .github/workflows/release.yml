name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    runs-on: ${{ matrix.os }}

    env:
      BIN_NAME: fekit

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Build
        run: cargo build --release --locked --bin ${{ env.BIN_NAME }}

      - name: Smoke test (fekit/fk)
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f "target/release/${BIN_NAME}.exe" ] && [ ! -f "target/release/${BIN_NAME}" ]; then
            echo "未找到二进制：target/release/${BIN_NAME}" >&2
            ls -la target/release || true
            exit 1
          fi
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            cp "target/release/${BIN_NAME}.exe" "target/release/fk.exe"
            "target/release/${BIN_NAME}.exe" --help >/dev/null
            "target/release/fk.exe" --help >/dev/null
          else
            ln -sf "target/release/${BIN_NAME}" "target/release/fk"
            "./target/release/${BIN_NAME}" --help >/dev/null
            "./target/release/fk" --help >/dev/null
          fi

      - name: Package
        shell: bash
        id: package
        run: |
          set -euo pipefail

          ARCH=$(uname -m)
          case "$ARCH" in
            x86_64|amd64|AMD64) ARCH="x86_64" ;;
            arm64|aarch64) ARCH="arm64" ;;
            *) echo "Unsupported architecture: $ARCH" >&2; exit 1 ;;
          esac

          case "${{ matrix.os }}" in
            ubuntu-latest) OS="linux" ;;
            macos-latest) OS="macos" ;;
            windows-latest) OS="windows" ;;
            *) echo "Unsupported OS: ${{ matrix.os }}" >&2; exit 1 ;;
          esac

          EXT=""
          if [ "$OS" = "windows" ]; then
            EXT=".exe"
          fi

          ASSET_NAME="${BIN_NAME}-${OS}-${ARCH}${EXT}"

          mkdir -p dist
          cp "target/release/${BIN_NAME}${EXT}" "dist/${ASSET_NAME}"

          echo "asset_name=${ASSET_NAME}" >> "$GITHUB_OUTPUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.asset_name }}
          path: dist/${{ steps.package.outputs.asset_name }}
          if-no-files-found: error

  release:
    needs: build
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
